<div class="card">
  <div class="card-body">
    <%= form_with(model: book, local: true) do |form| %>
      <% if book.errors.any? %>
        <div class="alert alert-danger">
          <h4 class="alert-heading"><%= pluralize(book.errors.count, "error") %> prohibited this book from being saved:</h4>
          <ul class="mb-0">
            <% book.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="mb-3">
        <%= form.label :title, class: 'form-label' %>
        <%= form.text_field :title, class: 'form-control', placeholder: 'Enter book title' %>
      </div>

      <div class="mb-3">
        <%= form.label :author, class: 'form-label' %>
        <%= form.text_field :author, class: 'form-control', placeholder: 'Enter author name' %>
      </div>

      <div class="mb-3">
        <%= form.label :price, class: 'form-label' %>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <%= form.number_field :price, step: 0.01, class: 'form-control', placeholder: '0.00' %>
        </div>
      </div>

      <div class="mb-3">
        <%= form.label :stock, class: 'form-label' %>
        <%= form.number_field :stock, class: 'form-control', placeholder: 'Enter stock quantity' %>
      </div>

      <div class="mb-3">
        <%= form.label :category_id, "Category", class: 'form-label' %>
        <%= form.select :category_id, options_from_collection_for_select(Category.all, :id, :name, book.category_id), { include_blank: 'Select a category' }, class: 'form-select' %>
      </div>

      <div class="mb-3">
        <%= form.label :description, class: 'form-label' %>
        <%= form.text_area :description, rows: 4, class: 'form-control', placeholder: 'Enter book description' %>
      </div>

      <div class="mb-3">
        <%= form.label :image, "Book Cover Image", class: 'form-label' %>
        <%= form.file_field :image, class: 'form-control', accept: 'image/png,image/jpg,image/jpeg,image/gif,image/webp', id: 'book_image_input' %>
        <div class="form-text">Accepted formats: PNG, JPG, JPEG, GIF, WEBP. Max size: 5MB</div>

        <% if book.persisted? && book.image.attached? %>
          <div class="mt-3">
            <p class="mb-2"><strong>Current Image:</strong></p>
            <%= image_tag book.image, class: 'img-thumbnail', style: 'max-width: 200px;', id: 'current_book_image' %>
            <div class="form-check mt-2">
              <%= form.check_box :remove_image, class: 'form-check-input', id: 'remove_image_checkbox' %>
              <%= form.label :remove_image, "Remove current image", class: 'form-check-label' %>
            </div>
          </div>
        <% end %>

        <div id="image_preview" class="mt-3" style="display: none;">
          <p class="mb-2"><strong>New Image Preview:</strong></p>
          <img id="preview_img" class="img-thumbnail" style="max-width: 200px;" />
        </div>
      </div>

      <div class="d-grid">
        <%= form.submit class: 'btn btn-primary btn-lg' %>
      </div>

      <script>
        document.getElementById('book_image_input').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('preview_img').src = e.target.result;
              document.getElementById('image_preview').style.display = 'block';
            }
            reader.readAsDataURL(file);
          } else {
            document.getElementById('image_preview').style.display = 'none';
          }
        });
      </script>
    <% end %>
  </div>
</div>
