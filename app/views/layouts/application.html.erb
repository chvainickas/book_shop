<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Book Shop" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Book Shop">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Book Shop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="categoriesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Categories
              </a>
              <ul class="dropdown-menu" aria-labelledby="categoriesDropdown">
                <li><%= link_to "All Books", books_path, class: "dropdown-item", data: { turbo: false } %></li>
                <li><hr class="dropdown-divider"></li>
                <% Category.all.each do |category| %>
                  <li><%= link_to category.name, books_path(category_id: category.id), class: "dropdown-item", data: { turbo: false } %></li>
                <% end %>
              </ul>
            </li>
            <% if logged_in? && !admin? %>
              <li class="nav-item">
                <%= link_to "My Orders", orders_path, class: "nav-link" %>
              </li>
            <% end %>
          </ul>
          <ul class="navbar-nav ms-auto">
            <% if logged_in? %>
              <% if !admin? %>
                <li class="nav-item">
                  <%= link_to wishlist_path, class: "nav-link position-relative" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                      <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                    </svg>
                    <% if current_user.wishlist_items.count > 0 %>
                      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        <%= current_user.wishlist_items.count %>
                      </span>
                    <% end %>
                  <% end %>
                </li>
                <li class="nav-item">
                  <%= link_to cart_path, class: "nav-link position-relative" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cart3" viewBox="0 0 16 16">
                      <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                    </svg>
                    <% if current_user.cart && current_user.cart.item_count > 0 %>
                      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        <%= current_user.cart.item_count %>
                      </span>
                    <% end %>
                  <% end %>
                </li>
              <% end %>
              <% if admin? %>
                <li class="nav-item">
                  <span class="nav-link">
                    <span class="badge bg-warning text-dark">Admin</span>
                  </span>
                </li>
              <% end %>
              <li class="nav-item">
                <span class="nav-link text-light"><%= current_user.email %></span>
              </li>
              <li class="nav-item">
                <%= link_to "Logout", logout_path, data: { turbo_method: :delete }, class: "nav-link" %>
              </li>
            <% else %>
              <li class="nav-item">
                <%= link_to "Login", login_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= link_to "Sign Up", signup_path, class: "nav-link" %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
      <% if notice.present? %>
        <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
          <div class="d-flex">
            <div class="toast-body">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
              </svg>
              <%= notice %>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      <% end %>

      <% if alert.present? %>
        <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
          <div class="d-flex">
            <div class="toast-body">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-circle-fill me-2" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
              </svg>
              <%= alert %>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      <% end %>
    </div>

    <main class="container mt-4 mb-5 pb-5">
      <%= yield %>
    </main>

    <footer class="bg-dark text-light py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-4 mb-3">
            <h5>Book Shop</h5>
            <p class="text-muted">Your one-stop destination for classic and contemporary literature.</p>
          </div>
          <div class="col-md-4 mb-3">
            <h5>Quick Links</h5>
            <ul class="list-unstyled">
              <li><%= link_to "Home", root_path, class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
              <li><%= link_to "All Books", books_path, class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
              <% if logged_in? && !admin? %>
                <li><%= link_to "My Orders", orders_path, class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
                <li><%= link_to "Wishlist", wishlist_path, class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
                <li><%= link_to "Cart", cart_path, class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
              <% end %>
            </ul>
          </div>
          <div class="col-md-4 mb-3">
            <h5>Categories</h5>
            <ul class="list-unstyled">
              <% Category.limit(5).each do |category| %>
                <li><%= link_to category.name, books_path(category_id: category.id), class: "text-muted text-decoration-none", data: { turbo_frame: "_top" } %></li>
              <% end %>
            </ul>
          </div>
        </div>
        <hr class="border-secondary">
        <div class="text-center text-muted">
          <p class="mb-0">&copy; <%= Time.current.year %> Book Shop. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" %>
    <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" %>

    <script data-turbo-eval="false">
      // Use a more aggressive approach with MutationObserver
      (function() {
        let dropdownsInitialized = false;

        // Clean up all dropdowns completely
        function cleanupDropdowns() {
          console.log('Cleaning up dropdowns...');
          // Remove show class from all dropdown menus
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.classList.remove('show');
            menu.removeAttribute('data-bs-popper');
            menu.removeAttribute('style');
          });

          // Reset all dropdown toggles
          document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(toggle) {
            toggle.setAttribute('aria-expanded', 'false');
            toggle.classList.remove('show');
          });

          // Dispose all Bootstrap dropdown instances
          document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(el) {
            const instance = bootstrap.Dropdown.getInstance(el);
            if (instance) {
              instance.dispose();
            }
          });
        }

        // Initialize Bootstrap components
        function initializeBootstrap() {
          console.log('Initializing Bootstrap dropdowns...');

          // Wait a tiny bit for DOM to settle
          setTimeout(function() {
            // First clean up any existing state
            cleanupDropdowns();

            // Initialize all dropdowns fresh
            const dropdownElementList = document.querySelectorAll('[data-bs-toggle="dropdown"]');
            console.log('Found ' + dropdownElementList.length + ' dropdowns to initialize');

            dropdownElementList.forEach(function(dropdownToggleEl) {
              // Make sure element is not already initialized
              const existing = bootstrap.Dropdown.getInstance(dropdownToggleEl);
              if (existing) {
                existing.dispose();
              }
              new bootstrap.Dropdown(dropdownToggleEl);
            });

            // Initialize all toasts and show them
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(function(toastElement) {
              const toast = new bootstrap.Toast(toastElement);
              toast.show();
            });

            dropdownsInitialized = true;
          }, 10);
        }

        // Clean up before Turbo caches the page
        document.addEventListener('turbo:before-cache', function() {
          console.log('turbo:before-cache event fired');
          cleanupDropdowns();
          dropdownsInitialized = false;
        });

        // Clean up before visiting a new page
        document.addEventListener('turbo:before-visit', function() {
          console.log('turbo:before-visit event fired');
          cleanupDropdowns();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOMContentLoaded event fired');
          initializeBootstrap();
        });

        // Initialize on Turbo navigation
        document.addEventListener('turbo:load', function() {
          console.log('turbo:load event fired');
          initializeBootstrap();
        });

        // Initialize on Turbo render
        document.addEventListener('turbo:render', function() {
          console.log('turbo:render event fired');
          initializeBootstrap();
        });

        // Initialize on Turbo frame render
        document.addEventListener('turbo:frame-render', function() {
          console.log('turbo:frame-render event fired');
          initializeBootstrap();
        });
      })();
    </script>
  </body>
</html>
